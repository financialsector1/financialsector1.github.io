<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø¯Ù…Ø¬ Ø®Ø±Ø§Ø¦Ø· - GIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>#map { height: 100vh; }</style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

<select id="mainSelector">
  <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
  <option value="banks">ğŸŸ¢ Ø§Ù„Ø¨Ù†ÙˆÙƒ</option>
  <option value="srafara">ğŸ”µ Ø§Ù„ØµØ±Ø§ÙØ§Øª</option>
  <option value="services">ğŸŸ¡ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¯ÙØ¹</option>
</select>

<select id="secondarySelector" style="display:none;"></select>
<button onclick="exportToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const map = L.map('map').setView([31.95, 35.23], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let layersGroup = L.layerGroup().addTo(map);
let excelData = [];

let palBanksURL = "https://palestinebank.github.io/pal_banks.json";
let palMangURL = "https://palestinebank.github.io/pal_mang.json";
let srafaraURL = "https://srafaramallah.github.io/srafara.json";
let servicesURL = "https://servicespayment.github.io/servicespayment.json";

let palBanks, palMang, srafara, services;

Promise.all([
  fetch(palBanksURL).then(res => res.json()),
  fetch(palMangURL).then(res => res.json()),
  fetch(srafaraURL).then(res => res.json()),
  fetch(servicesURL).then(res => res.json())
]).then(([b, m, s, v]) => {
  palBanks = b;
  palMang = m;
  srafara = s;
  services = v;

  document.getElementById("mainSelector").addEventListener("change", onMainChange);
  document.getElementById("secondarySelector").addEventListener("change", onSecondaryChange);
});

function onMainChange() {
  layersGroup.clearLayers();
  excelData = [];
  const type = this.value;
  const secondary = document.getElementById("secondarySelector");
  secondary.innerHTML = "";
  secondary.style.display = "none";

  if (type === "banks") {
    handleBanks();
  } else if (type === "srafara") {
    let names = [...new Set(srafara.features.map(f => f.properties.name))];
    names.forEach(n => {
      let op = document.createElement("option");
      op.value = n;
      op.textContent = n;
      secondary.appendChild(op);
    });
    secondary.style.display = "inline";
  } else if (type === "services") {
    let names = [...new Set(services.features.map(f => f.properties["Ø´Ø±ÙƒØ©"]))];
    names.forEach(n => {
      let op = document.createElement("option");
      op.value = n;
      op.textContent = n;
      secondary.appendChild(op);
    });
    secondary.style.display = "inline";
  }
}

function onSecondaryChange() {
  layersGroup.clearLayers();
  excelData = [];
  const main = document.getElementById("mainSelector").value;
  const val = this.value;
  if (main === "srafara") {
    handleSrafara(val);
  } else if (main === "services") {
    handleServices(val);
  }
}

function handleBanks() {
  const main = palMang.features[0];
  const [mlon, mlat] = main.geometry.coordinates;
  const mPoint = L.latLng(mlat, mlon);
  const mainMarker = L.marker(mPoint, {color: 'red'}).addTo(layersGroup).bindPopup("ğŸ¢ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ");
  map.setView(mPoint, 10);

  palBanks.features.forEach(f => {
    const [lon, lat] = f.geometry.coordinates;
    const dist = mPoint.distanceTo([lat, lon]) / 1000;
    const name = f.properties["Ø§Ù„Ø§Ø³Ù…"];
    const popup = `<b>${name}</b><br>ğŸ“ ${dist.toFixed(2)} ÙƒÙ…`;
    L.marker([lat, lon]).addTo(layersGroup).bindPopup(popup).openPopup();
    L.polyline([mPoint, [lat, lon]], {color:'green'}).addTo(layersGroup);
    excelData.push({ Ø§Ù„Ø§Ø³Ù…: name, Ø§Ù„Ù…Ø³Ø§ÙØ©: dist.toFixed(2) + " ÙƒÙ…" });
  });
}

function handleSrafara(name) {
  const features = srafara.features.filter(f => f.properties.name === name);
  if (features.length === 0) return;
  const main = features[Math.floor(Math.random() * features.length)];
  const [mlon, mlat] = main.geometry.coordinates;
  const mPoint = L.latLng(mlat, mlon);
  L.marker(mPoint, {color: 'red'}).addTo(layersGroup).bindPopup("ğŸ¢ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ").openPopup();
  map.setView(mPoint, 10);

  features.forEach(f => {
    const [lon, lat] = f.geometry.coordinates;
    const dist = mPoint.distanceTo([lat, lon]) / 1000;
    const addr = f.properties["Ø§Ù„Ø¹Ù†Ùˆ"];
    const popup = `<b>${f.properties.name}</b><br>ğŸ“ ${addr}<br>ğŸ“ ${dist.toFixed(2)} ÙƒÙ…`;
    L.marker([lat, lon]).addTo(layersGroup).bindPopup(popup).openPopup();
    L.polyline([mPoint, [lat, lon]], {color:'blue'}).addTo(layersGroup);
    excelData.push({ Ø§Ù„Ø§Ø³Ù…: f.properties.name, Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: addr, Ø§Ù„Ù…Ø³Ø§ÙØ©: dist.toFixed(2) + " ÙƒÙ…" });
  });
}

function handleServices(company) {
  const all = services.features.filter(f => f.properties["Ø´Ø±ÙƒØ©"] === company);
  const mains = all.slice(0, 5);
  mains.forEach(m => {
    const [mlon, mlat] = m.geometry.coordinates;
    const mPoint = L.latLng(mlat, mlon);
    L.marker(mPoint, {color: 'red'}).addTo(layersGroup).bindPopup("ğŸ¢ Ù…Ø±ÙƒØ² Ø±Ø¦ÙŠØ³ÙŠ").openPopup();

    all.forEach(f => {
      const [lon, lat] = f.geometry.coordinates;
      const dist = mPoint.distanceTo([lat, lon]) / 1000;
      const addr = f.properties["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"];
      const popup = `<b>${f.properties["Ø´Ø±ÙƒØ©"]}</b><br>ğŸ“ ${addr}<br>ğŸ“ ${dist.toFixed(2)} ÙƒÙ…`;
      L.marker([lat, lon]).addTo(layersGroup).bindPopup(popup).openPopup();
      L.polyline([mPoint, [lat, lon]], {color:'orange'}).addTo(layersGroup);
      excelData.push({ Ø§Ù„Ø´Ø±ÙƒØ©: f.properties["Ø´Ø±ÙƒØ©"], Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: addr, Ø§Ù„Ù…Ø³Ø§ÙØ©: dist.toFixed(2) + " ÙƒÙ…" });
    });
  });
}

function exportToExcel() {
  if (excelData.length === 0) {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(excelData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ø³Ø§ÙØ§Øª");
  XLSX.writeFile(wb, "Distances.xlsx");
}
</script>
</body>
</html>
