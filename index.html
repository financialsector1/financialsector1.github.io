<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>الخريطة الموحدة للبنوك والصرافات وخدمات الدفع</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      z-index: 1000;
      box-shadow: 0 0 5px #888;
      border-radius: 8px;
      width: 250px;
    }
    .controls select, .controls button {
      width: 100%;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="controls">
  <select id="layerSelect">
    <option value="banks">البنوك</option>
    <option value="srafara">الصرافات</option>
    <option value="services">خدمات الدفع</option>
  </select>

  <select id="subSelect" style="display:none;"></select>

  <button onclick="calculateDistances()">حساب المسافات</button>
  <button onclick="exportToExcel()">تصدير إلى Excel</button>
</div>

<script>
const map = L.map('map').setView([31.95, 35.2], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let layers = {
  banks: L.layerGroup().addTo(map),
  srafara: L.layerGroup(),
  services: L.layerGroup()
};

let allData = {
  banks: [],
  srafara: [],
  services: []
};

let currentLayer = 'banks';
let exportRows = [];

const dataSources = {
  banks: "https://raw.githubusercontent.com/palestinebank/palestinebank.github.io/main/pal_banks.json",
  pal_mang: "https://raw.githubusercontent.com/palestinebank/palestinebank.github.io/main/pal_mang.json",
  srafara: "https://raw.githubusercontent.com/srafaramallah/srafaramallah.github.io/main/srafara.json",
  services: "https://raw.githubusercontent.com/servicespayment/servicespayment.github.io/main/servicespayment.json"
};

// Load all layers
fetch(dataSources.pal_mang).then(res => res.json()).then(data => {
  const feature = data.features[0];
  const latlng = L.latLng(feature.geometry.coordinates[1], feature.geometry.coordinates[0]);
  feature.latlng = latlng;
  feature._popupContent = `<b>المركز الرئيسي</b><br>${feature.properties?.الاسم || ''}`;
  allData.pal_mang = feature;
});

['banks', 'srafara', 'services'].forEach(layer => {
  fetch(dataSources[layer])
    .then(res => res.json())
    .then(geojson => {
      allData[layer] = [];
      const geoLayer = L.geoJSON(geojson, {
        onEachFeature: (feature, layer) => {
          const latlng = layer.getLatLng();
          feature.latlng = latlng;
          feature._popupContent = Object.entries(feature.properties || {})
            .map(([k, v]) => `<b>${k}</b>: ${v}`).join('<br>');
          allData[layer].push(feature);
        },
        pointToLayer: (feature, latlng) => L.marker(latlng)
      });
      layers[layer].clearLayers();
      layers[layer].addLayer(geoLayer);
      if (layer !== currentLayer) layers[layer].remove();
    });
});

function switchLayer(layer) {
  Object.keys(layers).forEach(l => map.removeLayer(layers[l]));
  currentLayer = layer;
  map.addLayer(layers[layer]);
  updateSubSelect();
}

document.getElementById("layerSelect").addEventListener("change", e => {
  switchLayer(e.target.value);
});

document.getElementById("subSelect").addEventListener("change", e => {
  calculateDistances();
});

function updateSubSelect() {
  const sub = document.getElementById("subSelect");
  sub.style.display = 'none';
  sub.innerHTML = '';

  if (currentLayer === 'srafara') {
    const names = [...new Set(allData.srafara.map(f => f.properties?.الاسم))];
    sub.style.display = 'block';
    names.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      sub.appendChild(opt);
    });
  } else if (currentLayer === 'services') {
    const names = [...new Set(allData.services.map(f => f.properties?.شركة))];
    sub.style.display = 'block';
    names.forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      opt.textContent = n;
      sub.appendChild(opt);
    });
  }
}

function calculateDistances() {
  exportRows = [];
  if (currentLayer === 'banks') {
    const main = allData.pal_mang;
    allData.banks.forEach(f => {
      const dist = main.latlng.distanceTo(f.latlng) / 1000;
      const popup = f._popupContent + `<br><b>المسافة:</b> ${dist.toFixed(2)} كم`;
      L.polyline([main.latlng, f.latlng], { color: 'red' }).addTo(map);
      L.popup().setLatLng(f.latlng).setContent(popup).openOn(map);
      exportRows.push({ ...f.properties, "المسافة (كم)": dist.toFixed(2) });
    });
    L.popup().setLatLng(main.latlng).setContent(main._popupContent).openOn(map);
  }

  else if (currentLayer === 'srafara') {
    const name = document.getElementById("subSelect").value;
    const targets = allData.srafara.filter(f => f.properties?.الاسم === name);
    const center = targets[0];
    targets.slice(1).forEach(f => {
      const dist = center.latlng.distanceTo(f.latlng) / 1000;
      const popup = f._popupContent + `<br><b>المسافة:</b> ${dist.toFixed(2)} كم`;
      L.polyline([center.latlng, f.latlng], { color: 'green' }).addTo(map);
      L.popup().setLatLng(f.latlng).setContent(popup).openOn(map);
      exportRows.push({ ...f.properties, "المسافة (كم)": dist.toFixed(2) });
    });
    L.popup().setLatLng(center.latlng).setContent(center._popupContent).openOn(map);
  }

  else if (currentLayer === 'services') {
    const company = document.getElementById("subSelect").value;
    const related = allData.services.filter(f => f.properties?.شركة === company);
    const mains = related.slice(0, 5);
    mains.forEach(main => {
      related.forEach(f => {
        if (main === f) return;
        const dist = main.latlng.distanceTo(f.latlng) / 1000;
        const popup = f._popupContent + `<br><b>المسافة:</b> ${dist.toFixed(2)} كم`;
        L.polyline([main.latlng, f.latlng], { color: 'blue' }).addTo(map);
        L.popup().setLatLng(f.latlng).setContent(popup).openOn(map);
        exportRows.push({ ...f.properties, "المسافة (كم)": dist.toFixed(2) });
      });
    });
    mains.forEach(m => L.popup().setLatLng(m.latlng).setContent(m._popupContent + '<br><b>(مركز رئيسي)</b>').openOn(map));
  }
}

function exportToExcel() {
  if (exportRows.length === 0) {
    alert("لا توجد بيانات لتصديرها. الرجاء حساب المسافات أولاً.");
    return;
  }
  const worksheet = XLSX.utils.json_to_sheet(exportRows);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Distances");
  XLSX.writeFile(workbook, `${currentLayer}_distances.xlsx`);
}
</script>
</body>
</html>
