<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>الخريطة الموحدة - بنوك وصرافات وخدمات دفع</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    #map { height: 90vh; }
    #controls { padding: 10px; text-align: center; }
    select, button { margin: 5px; padding: 5px; }
  </style>
</head>
<body>
  <div id="controls">
    <select id="layerSelect">
      <option value="">اختر نوع البيانات</option>
      <option value="banks">البنوك</option>
      <option value="srafara">الصرافين</option>
      <option value="services">خدمات الدفع</option>
    </select>
    <select id="subSelect" style="display:none;"></select>
    <button onclick="exportToExcel()">تصدير إلى Excel</button>
  </div>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([31.9, 35.2], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let allLayers = [];
    let distanceData = [];

    function clearMap() {
      allLayers.forEach(l => map.removeLayer(l));
      allLayers = [];
      distanceData = [];
    }

    function toRad(x) { return x * Math.PI / 180; }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    async function loadJSON(url) {
      const res = await fetch(url);
      return await res.json();
    }

    async function handleLayerChange(type) {
      clearMap();
      const subSelect = document.getElementById('subSelect');
      subSelect.style.display = 'none';
      subSelect.innerHTML = '';

      if (type === 'banks') {
        const mang = await loadJSON('https://palestinebank.github.io/pal_mang.json');
        const banks = await loadJSON('https://palestinebank.github.io/pal_banks.json');
        const main = mang.features[0];
        const [mainLon, mainLat] = main.geometry.coordinates;
        const mainMarker = L.marker([mainLat, mainLon], {color: 'red'}).addTo(map).bindPopup('المركز الرئيسي').openPopup();
        allLayers.push(mainMarker);

        banks.features.forEach(f => {
          const [lon, lat] = f.geometry.coordinates;
          const distance = haversine(mainLat, mainLon, lat, lon).toFixed(2);
          const name = f.properties["الاسم"];
          const marker = L.marker([lat, lon]).addTo(map).bindPopup(`${name}<br>المسافة: ${distance} كم`).openPopup();
          const line = L.polyline([[mainLat, mainLon], [lat, lon]], {color: 'blue'}).addTo(map);
          allLayers.push(marker, line);
          distanceData.push({"الاسم": name, "المسافة (كم)": distance});
        });

      } else if (type === 'srafara') {
        const data = await loadJSON('https://srafaramallah.github.io/srafara.json');
        const names = [...new Set(data.features.map(f => f.properties["اسم_ا"]))];
        subSelect.style.display = 'inline-block';
        names.forEach(n => {
          const opt = document.createElement('option');
          opt.value = n; opt.textContent = n;
          subSelect.appendChild(opt);
        });
        subSelect.onchange = () => showSrafara(data, subSelect.value);

      } else if (type === 'services') {
        const data = await loadJSON('https://servicespayment.github.io/servicespayment.json');
        const names = [...new Set(data.features.map(f => f.properties["شركة"]))];
        subSelect.style.display = 'inline-block';
        names.forEach(n => {
          const opt = document.createElement('option');
          opt.value = n; opt.textContent = n;
          subSelect.appendChild(opt);
        });
        subSelect.onchange = () => showServices(data, subSelect.value);
      }
    }

    function showSrafara(data, name) {
      clearMap();
      const features = data.features.filter(f => f.properties["اسم_ا"] === name);
      if (features.length === 0) return;
      const main = features[Math.floor(Math.random() * features.length)];
      const [mainLon, mainLat] = main.geometry.coordinates;
      const mainMarker = L.marker([mainLat, mainLon], {color: 'red'}).addTo(map).bindPopup('المركز الرئيسي').openPopup();
      allLayers.push(mainMarker);

      features.forEach(f => {
        const [lon, lat] = f.geometry.coordinates;
        const distance = haversine(mainLat, mainLon, lat, lon).toFixed(2);
        const title = f.properties["اسم_ا"];
        const address = f.properties["العنو"] || "غير متوفر";
        const marker = L.marker([lat, lon]).addTo(map).bindPopup(`${title}<br>العنوان: ${address}<br>المسافة: ${distance} كم`).openPopup();
        const line = L.polyline([[mainLat, mainLon], [lat, lon]], {color: 'green'}).addTo(map);
        allLayers.push(marker, line);
        distanceData.push({"الاسم": title, "العنوان": address, "المسافة (كم)": distance});
      });
    }

    function showServices(data, name) {
      clearMap();
      const features = data.features.filter(f => f.properties["شركة"] === name);
      if (features.length === 0) return;
      const centers = features.slice(0, 5);

      centers.forEach(center => {
        const [mainLon, mainLat] = center.geometry.coordinates;
        const centerName = center.properties["شركة"];
        const address = center.properties["العنوان"] || "غير متوفر";
        const centerMarker = L.marker([mainLat, mainLon], {color: 'red'}).addTo(map).bindPopup(`مركز رئيسي - ${centerName}<br>${address}`).openPopup();
        allLayers.push(centerMarker);

        features.forEach(f => {
          const [lon, lat] = f.geometry.coordinates;
          const distance = haversine(mainLat, mainLon, lat, lon).toFixed(2);
          const title = f.properties["شركة"];
          const address = f.properties["العنوان"] || "غير متوفر";
          const marker = L.marker([lat, lon]).addTo(map).bindPopup(`${title}<br>العنوان: ${address}<br>المسافة: ${distance} كم`).openPopup();
          const line = L.polyline([[mainLat, mainLon], [lat, lon]], {color: 'orange'}).addTo(map);
          allLayers.push(marker, line);
          distanceData.push({"الاسم": title, "العنوان": address, "المسافة (كم)": distance});
        });
      });
    }

    function exportToExcel() {
      const ws = XLSX.utils.json_to_sheet(distanceData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Distances');
      XLSX.writeFile(wb, 'distances.xlsx');
    }

    document.getElementById('layerSelect').addEventListener('change', e => handleLayerChange(e.target.value));
  </script>
</body>
</html>
